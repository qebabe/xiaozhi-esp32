# Bread Compact WiFi 步进电机功能使用指南

## 概述

Bread Compact WiFi板子现已集成了ULN2003步进电机驱动功能，支持通过MCP协议远程控制28BYJ-48等步进电机。

## 硬件连接

### ULN2003与ESP32-S3的连接

| ULN2003引脚 | ESP32-S3 GPIO | 功能描述 |
|-------------|---------------|----------|
| IN1        | GPIO 1       | 步进电机相位1 |
| IN2        | GPIO 2       | 步进电机相位2 |
| IN3        | GPIO 3       | 步进电机相位3 |
| IN4        | GPIO 8       | 步进电机相位4 |
| GND        | GND          | 电源地 |
| VCC        | 5V           | 电源正（ULN2003需要5V供电） |

### 步进电机连接

| 28BYJ-48电机线色 | ULN2003输出 | 功能 |
|------------------|-------------|------|
| 橙色 (Orange)   | OUT1       | 相位1 |
| 黄色 (Yellow)   | OUT2       | 相位2 |
| 粉色 (Pink)     | OUT3       | 相位3 |
| 蓝色 (Blue)     | OUT4       | 相位4 |
| 红色 (Red)      | +5V        | 电机电源 |

## 软件功能

### MCP协议接口

步进电机控制器提供了以下MCP工具：

#### 1. 获取电机状态
```json
{
  "tool": "self.stepper.get_state",
  "parameters": {}
}
```
**响应**:
```json
{
  "running": true,
  "remaining_steps": 512
}
```

#### 2. 启动连续转动
```json
{
  "tool": "self.stepper.start",
  "parameters": {
    "direction": "clockwise"
  }
}
```
- `direction`: `"clockwise"` (顺时针) 或 `"counterclockwise"` (逆时针)

#### 3. 按步数转动
```json
{
  "tool": "self.stepper.step",
  "parameters": {
    "steps": 1024
  }
}
```
- `steps`: 正数表示顺时针转动，负数表示逆时针转动

#### 4. 停止电机
```json
{
  "tool": "self.stepper.stop",
  "parameters": {}
}
```

#### 5. 设置转速
```json
{
  "tool": "self.stepper.set_speed",
  "parameters": {
    "rpm": 15.0
  }
}
```
- `rpm`: 每分钟转数 (RPM)，范围建议 1-20

## 电机参数

### 28BYJ-48步进电机规格
- **步进角度**: 5.625°/步 (半步进模式)
- **减速比**: 1:64
- **每圈步数**: 2048步 (8步序列 × 256微步)
- **额定电压**: 5V DC
- **相位电流**: ≤250mA

### 性能参数
- **最大转速**: ~20 RPM (受FreeRTOS任务调度限制)
- **最小转速**: ~1 RPM
- **控制精度**: 2048步/圈
- **保持扭矩**: 约34.3mN·m

## 使用示例

### XiaoZhi AI对话控制

你可以通过语音命令XiaoZhi来控制步进电机：

**对话示例**:
```
用户: "请让步进电机顺时针转动5圈"
XiaoZhi: "好的，我来控制步进电机顺时针转动5圈"

用户: "电机转得太快了，请调慢一点"
XiaoZhi: "我将电机转速调整为10转每分钟"

用户: "停止电机转动"
XiaoZhi: "电机已停止转动"
```

### 编程接口

如果你需要在代码中直接控制电机：

```cpp
#include "wifi_board.h"

// 获取板子实例
auto& board = static_cast<CompactWifiBoard&>(WifiBoard::GetInstance());
auto stepper = board.GetStepperMotor();

// 设置转速为10 RPM
stepper->SetSpeed(10.0f);

// 正转2048步 (1圈)
stepper->Step(2048);

// 反转1024步 (半圈)
stepper->Step(-1024);

// 连续正转
stepper->Start(true);

// 停止
stepper->Stop();
```

## 注意事项

### 硬件注意事项
1. **电源供应**: ULN2003需要稳定的5V电源供电
2. **电流限制**: 步进电机工作时会产生较大电流，确保电源充足
3. **散热**: 长时间工作时ULN2003会发热，注意散热
4. **线序**: 确保步进电机线缆连接正确，错误的线序会导致电机不转或乱转

### 软件注意事项
1. **任务优先级**: 电机控制任务优先级设为5，确保实时性
2. **速度限制**: 过高的转速可能导致电机控制不稳定
3. **资源占用**: 电机控制会持续占用一个FreeRTOS任务

### 安全注意事项
1. **过载保护**: 避免电机堵转，及时检测并停止
2. **温度监控**: 长时间工作时注意电机和驱动芯片温度
3. **电源稳定性**: 确保电源电压稳定，避免电压波动影响控制

## 故障排除

### 电机不转动
1. 检查ULN2003供电是否正常 (5V)
2. 确认步进电机线序是否正确
3. 检查GPIO引脚是否被其他功能占用
4. 验证MCP命令是否正确发送

### 电机抖动或噪音大
1. 降低转速 (减少RPM值)
2. 检查电源稳定性
3. 确认电机机械部分无卡阻

### 控制无响应
1. 检查XiaoZhi是否正确连接到服务器
2. 验证MCP工具是否正确注册
3. 查看ESP32日志输出

## 扩展应用

### 可能的扩展功能
- **位置控制**: 添加编码器实现精确位置控制
- **多电机控制**: 支持同时控制多个步进电机
- **运动模式**: 实现加速/减速曲线
- **物联网集成**: 与其他智能设备联动

### 应用场景
- **智能家居**: 窗帘控制、百叶窗调节
- **机器人**: 关节控制、机械臂定位
- **自动化设备**: 阀门控制、传送带驱动
- **教学实验**: 电机控制原理演示

---

*该功能基于ULN2003驱动芯片和28BYJ-48步进电机设计，如使用其他型号的电机或驱动芯片可能需要调整控制参数。*