# 打开终端先加载 ESP-IDF 环境
esp-idf-env
idf.py --version



# 将构建出来的四个bin文件打包成一个
cd build

python3 -m esptool --chip esp32s3 merge_bin -o merged-xiaozhi-firmware-0.6.bin --flash_mode dio --flash_freq 80m --flash_size 16MB 0x0000 bootloader/bootloader.bin 0x8000 partition_table/partition-table.bin 0xd000 ota_data_initial.bin 0x20000 xiaozhi.bin 0x800000 generated_assets.bin


# ============================================
# qebabe-xiaoche（小车玩法）详细功能分析
# ============================================

## 📋 概述
qebabe-xiaoche是基于ESP32的小车机器人，支持通过语音指令控制电机运动，以及查询网络状态。

## 🎮 电机控制玩法（9个MCP工具）

### 1. 前进控制
**指令示例：**
- "小智，让小车前进"
- "小智，小车向前走"
- "让机器人前进5秒钟"

**MCP工具：** `self.motor.move_forward`
**参数：**
- `speed_percent`: 速度百分比 (0-100，默认100)
- `duration_ms`: 持续时间毫秒 (100-10000，默认5000)

**响应：** "Moved forward at X% speed for Yms"

### 2. 后退控制
**指令示例：**
- "小智，让小车后退"
- "小车往后走"
- "机器人后退3秒"

**MCP工具：** `self.motor.move_backward`
**参数：** 同前进控制

**响应：** "Moved backward at X% speed for Yms"

### 3. 原地转圈
**指令示例：**
- "小智，小车转圈"
- "让机器人原地旋转"
- "小车转一圈"

**MCP工具：** `self.motor.spin_around`
**参数：**
- `speed_percent`: 速度百分比 (0-100，默认100)

**响应：** "Spin around completed at X% speed"

### 4. 左转控制
**指令示例：**
- "小智，向左转"
- "小车左转90度"
- "机器人往左转"

**MCP工具：** `self.motor.turn_left`
**参数：**
- `speed_percent`: 速度百分比 (0-100，默认100)
- `duration_ms`: 转弯持续时间毫秒 (100-5000，默认600，大约90度)

**响应：** "Turned left at X% speed for Yms"

### 5. 右转控制
**指令示例：**
- "小智，向右转"
- "小车右转"
- "机器人往右转弯"

**MCP工具：** `self.motor.turn_right`
**参数：** 同左转控制

**响应：** "Turned right at X% speed for Yms"

### 6. 快速前进
**指令示例：**
- "小智，快速前进"
- "小车快点往前走"
- "冲锋！"

**MCP工具：** `self.motor.quick_forward`
**参数：**
- `speed_percent`: 速度百分比 (0-100，默认100)

**执行时间：** 固定0.5秒
**响应：** "Quick forward movement completed at X% speed"

### 7. 快速后退
**指令示例：**
- "小智，快退"
- "小车后退"
- "撤退！"

**MCP工具：** `self.motor.quick_backward`
**参数：** 同快速前进

**响应：** "Quick backward movement completed at X% speed"

### 8. 扭动动作
**指令示例：**
- "小智，扭一扭"
- "小车扭动一下"
- "机器人跳舞"

**MCP工具：** `self.motor.wiggle`
**参数：**
- `speed_percent`: 速度百分比 (0-100，默认100)

**执行动作：** 快速右转一下（约300ms）
**响应：** "Wiggle movement completed at X% speed"

### 9. 舞蹈动作
**指令示例：**
- "小智，跳舞"
- "小车表演舞蹈"
- "机器人跳个舞"

**MCP工具：** `self.motor.dance`
**参数：**
- `speed_percent`: 速度百分比 (0-100，默认100)

**执行动作：** 快速前进一下（约400ms）
**响应：** "Dance movement completed at X% speed"

### 10. 停止控制
**指令示例：**
- "小智，停下"
- "小车停止"
- "机器人别动了"

**MCP工具：** `self.motor.stop`
**参数：** 无

**响应：** "Motor stopped"

## 🌐 网络状态查询玩法

### IP地址查询
**指令示例：**
- "小智，我的IP地址是多少"
- "小车现在连的什么网络"
- "告诉我当前IP地址"

**MCP工具：** `self.network.get_ip`
**参数：** 无

**响应：**
- 已连接WiFi： "当前IP地址是192.168.1.100"
- 未连接WiFi： "当前未连接到WiFi网络，无法获取IP地址"

## 🎯 实际语音交互示例

### 基础移动
```
用户：小智，让小车前进
小智：好的，我来控制小车前进 (执行前进动作)
小智：Moved forward at 100% speed for 5000ms

用户：停下
小智：好的，停止移动 (执行停止动作)
小智：Motor stopped
```

### 趣味动作
```
用户：小智，跳个舞
小智：好的，小车来跳舞啦！ (执行舞蹈动作)
小智：Dance movement completed at 100% speed

用户：扭一扭
小智：哈哈，小车扭起来！ (执行扭动动作)
小智：Wiggle movement completed at 100% speed
```

### 网络查询
```
用户：小智，我的IP地址是多少
小智：让我帮您查询一下当前IP地址 (调用网络查询)
小智：当前IP地址是192.168.1.100
```

## ⚙️ 技术参数

### 电机控制参数范围
- **速度控制：** 0-100% (0=停止，100=全速)
- **持续时间：** 100-10000毫秒 (0.1秒-10秒)
- **转弯角度：** 通过时间控制，大约600ms=90度

### PWM电机控制
- 支持4路PWM输出 (左前、左后、右前、右后)
- 频率：5KHz
- 占空比：0-100%

### 动作优先级
- 普通动作：优先级1
- MCP控制动作：优先级2 (可中断普通动作)

## 🌐 网页遥控玩法

小智小车还支持通过网页浏览器进行遥控操作，提供更直观的交互体验。

### 网页访问方式

1. **自动启动**：设备连接WiFi后会自动启动网页服务器
2. **访问地址**：在浏览器中输入小车的IP地址（如：`http://192.168.1.100`）
3. **端口**：默认使用80端口

### 网页遥控界面功能

#### 🎮 虚拟摇杆控制
- **触摸操作**：在摇杆区域触摸或拖拽来控制小车移动
- **方向控制**：
  - 上拖拽 → 前进
  - 下拖拽 → 后退
  - 左拖拽 → 左转
  - 右拖拽 → 右转
- **速度控制**：拖拽距离越远，速度越快（0-100%）
- **实时反馈**：摇杆会显示当前方向图标（⬆️前进 ⬇️后退 ⬅️左转 ➡️右转）

#### 🛑 控制按钮
- **停止按钮**：红色停止按钮，立即停止所有运动
- **测试按钮**：测试前进功能（前进1秒后自动停止）

#### 📊 状态显示
- **连接状态**：显示"已连接"或"连接错误"
- **实时反馈**：操作时会更新连接状态

### 网页控制API接口

#### 主要API端点
- **GET /**：返回遥控界面HTML页面
- **POST /api/control**：发送控制命令（JSON格式）
- **POST /control**：发送简单控制命令
- **POST /api/debug/motor_test**：电机测试接口

#### API使用示例

**发送前进命令：**
```javascript
fetch('/api/control', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ direction: 4, speed: 80 })
});
```

**发送停止命令：**
```javascript
fetch('/api/control', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ direction: 0, speed: 0 })
});
```

**方向代码：**
- `0`：停止
- `1`：右转
- `2`：后退
- `3`：左转
- `4`：前进

### 网页遥控特点

#### ✅ 优点
- **无需安装APP**：直接用浏览器访问
- **跨平台支持**：支持手机、平板、电脑
- **实时控制**：低延迟的实时响应
- **直观界面**：虚拟摇杆操作简单易用
- **响应式设计**：自动适配不同屏幕尺寸

#### ⚙️ 技术特性
- **防并发请求**：避免同时发送多个重复命令
- **自动重连**：网络异常时自动重试
- **触摸优化**：支持触摸屏设备
- **状态同步**：实时显示连接状态

### 网页遥控使用场景

1. **远程调试**：无需直接接触设备即可测试电机功能
2. **演示展示**：通过手机遥控进行产品演示
3. **家庭娱乐**：家人可以通过手机控制小车玩耍
4. **教育应用**：编程学习和机器人控制教学

## 💡 使用建议

1. **参数调节**：可以指定速度和时间，如"以50%速度前进3秒"
2. **组合动作**：可以连续发出多个指令实现复杂路线
3. **安全控制**：随时可以用"停下"指令紧急停止
4. **网络监控**：定期查询IP地址确认网络连接状态
5. **网页遥控**：在同一WiFi网络下使用浏览器访问IP地址进行遥控

## 🔧 自定义开发

如需添加新的动作，可以在`InitializeTools()`函数中添加新的MCP工具，并实现对应的电机控制逻辑。网页遥控会自动支持所有新的电机控制功能。

